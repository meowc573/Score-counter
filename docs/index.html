<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ตัวนับคะแนน</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      padding: 20px;
      max-width: 400px;
      margin: auto;
      background: #f0f2f5;
      color: #333;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #4a90e2;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 16px;
      transition: background 0.3s;
    }
    button:hover {
      background: #f5a623;
    }
    .output {
      background: #fff;
      padding: 16px;
      margin-top: 24px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
    }
  </style>
</head>
<body>

  <h1>ตัวนับคะแนน</h1>

  <label>คะแนน (Points)</label>
  <input type="number" id="points" value="100" min="0" />

  <label>ทุกๆ (จำนวน) หน่วยเวลา</label>
  <div style="display:flex; gap:10px;">
    <input type="number" id="timeAmount" value="10" min="1" style="flex:1" />
    <select id="timeUnit" style="flex:1">
      <option value="seconds">วินาที</option>
      <option value="minutes" selected>นาที</option>
      <option value="hours">ชั่วโมง</option>
      <option value="days">วัน</option>
    </select>
  </div>

  <label>คะแนนเป้าหมาย (ถ้ามี)</label>
  <input type="number" id="targetScore" placeholder="ใส่คะแนนเป้าหมาย (ถ้ามี)" />

  <div style="display:flex; gap:10px;">
    <button onclick="start()">เริ่ม</button>
    <button onclick="pause()">พัก</button>
    <button onclick="reset()">รีเซต</button>
  </div>

  <div class="output">
    <p>สถานะ: <span id="status">รอเริ่ม...</span></p>
    <p>คะแนน: <span id="score">0.00</span></p>
    <p>เวลาที่ใช้ทั้งหมด (วินาที): <span id="elapsed">-</span></p>
    <p>เวลาที่ผ่านไป: <span id="timePassed">-</span></p>
    <p>เวลาที่เหลือ: <span id="timeRemaining">-</span></p>
  </div>

<script>
  function formatTime(ms) {
    if (ms < 0) ms = 0;
    const sec = Math.floor(ms / 1000);
    const days = Math.floor(sec / 86400);
    const hours = Math.floor((sec % 86400) / 3600);
    const minutes = Math.floor((sec % 3600) / 60);
    const seconds = sec % 60;
    return `${days} วัน ${hours} ชม. ${minutes} นาที ${seconds} วิ`;
  }

  function calculateRate() {
    const points = parseFloat(document.getElementById("points").value) || 0;
    const timeAmount = parseFloat(document.getElementById("timeAmount").value) || 1;
    const unit = document.getElementById("timeUnit").value;

    let seconds = timeAmount;
    if (unit === "minutes") seconds *= 60;
    else if (unit === "hours") seconds *= 3600;
    else if (unit === "days") seconds *= 86400;

    return points / seconds;
  }

  function saveState(state) {
    localStorage.setItem("counterState", JSON.stringify(state));
  }

  function loadState() {
    const data = localStorage.getItem("counterState");
    if (data) {
      try {
        return JSON.parse(data);
      } catch {
        return null;
      }
    }
    return null;
  }

  function clearState() {
    localStorage.removeItem("counterState");
  }

  let score = 0;
  let startTime = null;
  let pausedTime = 0;
  let pauseStart = null;
  let interval = null;
  let ratePerSecond = 0;
  let isRunning = false;

  function update() {
    if (!isRunning) return;

    const now = new Date();
    const elapsed = (now - startTime - pausedTime) / 1000;
    score = elapsed * ratePerSecond;

    // เวลาที่ใช้ทั้งหมด (คำนวณจากคะแนน)
    const elapsedCalc = score / ratePerSecond;

    document.getElementById("score").textContent = score.toFixed(2);
    document.getElementById("elapsed").textContent = Math.floor(elapsedCalc);

    const target = parseFloat(document.getElementById("targetScore").value);
    if (!isNaN(target) && ratePerSecond > 0) {
      const remainingMs = ((target - score) / ratePerSecond) * 1000;
      document.getElementById("timeRemaining").textContent = formatTime(remainingMs);
      document.getElementById("timePassed").textContent = formatTime(elapsed * 1000);

      if (score >= target) {
        clearInterval(interval);
        interval = null;
        isRunning = false;
        document.getElementById("status").textContent = "ถึงเป้าหมายแล้ว!";
        document.getElementById("timeRemaining").textContent = "0 วินาที";
        return;
      }
    } else {
      document.getElementById("timeRemaining").textContent = "-";
      document.getElementById("timePassed").textContent = formatTime(elapsed * 1000);
    }

    document.getElementById("status").textContent = "กำลังนับคะแนน...";

    saveState({
      startTime: startTime.getTime(),
      pausedTime,
      pauseStart: pauseStart ? pauseStart.getTime() : null,
      score,
      ratePerSecond,
      isRunning,
      targetScore: target || null,
      points: document.getElementById("points").value,
      timeAmount: document.getElementById("timeAmount").value,
      timeUnit: document.getElementById("timeUnit").value,
    });
  }

  function start() {
    if (isRunning) return;

    ratePerSecond = calculateRate();
    if (ratePerSecond <= 0) {
      alert("กรุณาใส่คะแนนและหน่วยเวลาที่ถูกต้อง");
      return;
    }

    if (!startTime) {
      startTime = new Date();
    }

    if (pauseStart) {
      pausedTime += new Date() - pauseStart;
      pauseStart = null;
    }

    isRunning = true;

    if (interval) clearInterval(interval);
    interval = setInterval(update, 1000);
    update();
  }

  function pause() {
    if (!isRunning) return;

    clearInterval(interval);
    interval = null;
    pauseStart = new Date();
    isRunning = false;
    document.getElementById("status").textContent = "หยุดชั่วคราว";

    saveState({
      startTime: startTime.getTime(),
      pausedTime,
      pauseStart: pauseStart.getTime(),
      score,
      ratePerSecond,
      isRunning,
      targetScore: parseFloat(document.getElementById("targetScore").value) || null,
      points: document.getElementById("points").value,
      timeAmount: document.getElementById("timeAmount").value,
      timeUnit: document.getElementById("timeUnit").value,
    });
  }

  function reset() {
    clearInterval(interval);
    interval = null;
    score = 0;
    startTime = null;
    pausedTime = 0;
    pauseStart = null;
    isRunning = false;

    document.getElementById("score").textContent = "0.00";
    document.getElementById("elapsed").textContent = "-";
    document.getElementById("timePassed").textContent = "-";
    document.getElementById("timeRemaining").textContent = "-";
    document.getElementById("status").textContent = "รอเริ่ม...";

    clearState();
  }

  window.addEventListener("load", () => {
    const saved = loadState();
    if (saved) {
      document.getElementById("points").value = saved.points || 100;
      document.getElementById("timeAmount").value = saved.timeAmount || 10;
      document.getElementById("timeUnit").value = saved.timeUnit || "minutes";
      document.getElementById("targetScore").value = saved.targetScore || "";

      startTime = saved.startTime ? new Date(saved.startTime) : null;
      pausedTime = saved.pausedTime || 0;
      pauseStart = saved.pauseStart ? new Date(saved.pauseStart) : null;
      ratePerSecond = saved.ratePerSecond || calculateRate();
      score = saved.score || 0;
      isRunning = saved.isRunning || false;

      document.getElementById("score").textContent = score.toFixed(2);

      if (isRunning) {
        interval = setInterval(update, 1000);
        update();
      } else if (pauseStart) {
        document.getElementById("status").textContent = "หยุดชั่วคราว";
      } else {
        document.getElementById("status").textContent = "รอเริ่ม...";
      }
    }
  });
</script>

</body>
</html>
